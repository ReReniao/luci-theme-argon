# .github/workflows/build.yml

name: Build OpenWrt Package (using SDK)

on:
  push:
    branches: [ "main", "master" ]
    tags: [ "v*" ]
  workflow_dispatch:

# ======================================================================================
# ==                        ğŸ‘‡ User configuration area ğŸ‘‡                            ==
# ======================================================================================
env:
  # 1. è®¾ç½®ä½ è¦ç¼–è¯‘çš„è½¯ä»¶åŒ…åç§° (å¿…é¡»ä¸ä½ çš„è½¯ä»¶åŒ…ç›®å½•åç›¸åŒ)
  #    ä¾‹å¦‚: luci-app-adguardhome, v2ray-core, kmod-wireguard ç­‰
  PACKAGE_NAME: luci-theme-argon

  # 2. è®¾ç½®è¦ç¼–è¯‘çš„ OpenWrt ç‰ˆæœ¬ (å¿…é¡»æ˜¯å®˜æ–¹çš„æ­£å¼å‘å¸ƒç‰ˆæ ‡ç­¾, ä¾‹å¦‚ 'v23.05.3')
  #    æ³¨æ„ï¼šæ­¤æ–¹æ³•ä¸æ”¯æŒ 'master' æˆ– 'openwrt-23.05' ç­‰åˆ†æ”¯å
  OPENWRT_VERSION: 'v23.05.3'

  # 3. æŒ‡å®šSDKä¿å­˜ç›®å½•ï¼Œä¸€èˆ¬ä¸ç”¨ä¿®æ”¹
  SDK_DIR: /home/runner/work/openwrt-sdk
# ======================================================================================
# ==                        ğŸ‘† User configuration area ğŸ‘†                            ==
# ======================================================================================

permissions:
  contents: write

jobs:
  build:
    name: Build for ${{ matrix.target.name }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        target:
          # ç¼–è¯‘çš„pathåœ¨https://downloads.openwrt.org/releases/23.05.3/targets è¿™é‡ŒæŸ¥æ‰¾ï¼Œnameéšæ„
          - name: mediatek_filogic
            path: mediatek/filogic

    steps:
      # æ­¥éª¤ 1: æ£€å‡ºä»£ç 
      - name: Checkout package repository
        uses: actions/checkout@v4

      # æ­¥éª¤ 2: å®‰è£…ä¾èµ–
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential rsync unzip zstd

      # æ­¥éª¤ 3: ç¼“å­˜ OpenWrt SDK
      - name: Cache OpenWrt SDK
        id: cache-sdk
        uses: actions/cache@v4
        with:
          path: ${{ env.SDK_DIR }}
          key: ${{ runner.os }}-sdk-${{ matrix.target.name }}-${{ env.OPENWRT_VERSION }}

      # æ­¥éª¤ 4: å‡†å¤‡ SDK (ä»…åœ¨ç¼“å­˜æœªå‘½ä¸­æ—¶è¿è¡Œ)
      - name: Download, extract OpenWrt SDK and update feeds
        if: steps.cache-sdk.outputs.cache-hit != 'true'
        run: |
          release_version="${OPENWRT_VERSION#v}"
          sdk_url_prefix="https://downloads.openwrt.org/releases/${release_version}/targets/${{ matrix.target.path }}"
          
          sdk_filename=$(curl -s "$sdk_url_prefix/" | \
                        grep -o '<a href="openwrt-sdk-.*-x86_64\.tar\.\(xz\|zst\)">' | \
                        sed -e 's/.*<a href="//' -e 's/">//' | \
                        head -n 1)

          if [ -z "$sdk_filename" ]; then
            echo "::error::Could not find SDK file at ${sdk_url_prefix}/"
            echo "Available files:"
            curl -s "$sdk_url_prefix/" | grep -o '<a href="[^"]*">[^<]*</a>' | sed -e 's/<a href="\(.*\)".*>\(.*\)/\1\t\2/'
            exit 1
          fi
          
          echo "Downloading SDK: ${sdk_url_prefix}/${sdk_filename}"
          wget -q "${sdk_url_prefix}/${sdk_filename}"
          
          echo "Extracting SDK..."
          tar -xf "$sdk_filename"
          mv $(find . -maxdepth 1 -type d -name 'openwrt-sdk-*') ${{ env.SDK_DIR }}

          echo "Updating feeds..."
          cd ${{ env.SDK_DIR }}
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          cd ..

      # æ­¥éª¤ 5: å‡†å¤‡æ„å»ºé…ç½®ï¼ˆæ ¸å¿ƒä¿®å¤ï¼šå…ˆåˆ¤æ–­ç›®å½•æ˜¯å¦å­˜åœ¨å†æ¸…ç†ï¼‰
      - name: Prepare build environment
        working-directory: ${{ env.SDK_DIR }}
        run: |
          # æ¸…ç†æ—§çš„è½¯ä»¶åŒ…ç›®å½•
          rm -rf package/${{ env.PACKAGE_NAME }}
          # å¤åˆ¶æ–°çš„è½¯ä»¶åŒ…ä»£ç 
          cp -r ${{ github.workspace }} ./package/
          # æå–è¯­è¨€åŒ…åç§°ï¼ˆå»æ‰ luci-app- å‰ç¼€ï¼‰
          translation_pkg=${PACKAGE_NAME#luci-app-}
          
          # å…³é”®ä¿®å¤ï¼šä»…å½“ bin/packages ç›®å½•å­˜åœ¨æ—¶ï¼Œæ‰æ‰§è¡Œæ¸…ç†æ—§äº§ç‰©
          if [ -d "./bin/packages" ]; then
            find ./bin/packages -type f -name "${PACKAGE_NAME}*.ipk" -delete
            find ./bin/packages -type f -name "luci-i18n-${translation_pkg}-*.ipk" -delete
            echo "Cleaned old IPK files in ./bin/packages/"
          else
            echo "./bin/packages directory does not exist, skip cleaning old IPK files"
          fi
          
          # ç”Ÿæˆç¼–è¯‘é…ç½®æ–‡ä»¶
          {
            echo "CONFIG_PACKAGE_${PACKAGE_NAME}=m"
            echo "CONFIG_PACKAGE_luci-i18n-${translation_pkg}-zh-cn=m"
            echo "CONFIG_LUCI_LANG_zh_Hans=y"
          } > .config
          make defconfig

      # æ­¥éª¤ 6: ç¼–è¯‘è½¯ä»¶åŒ…
      - name: Compile the package
        working-directory: ${{ env.SDK_DIR }}
        run: |
          make package/${PACKAGE_NAME}/compile V=s -j$(($(nproc) + 1))

      # æ­¥éª¤ 7: æŸ¥æ‰¾å¹¶å‡†å¤‡ .ipk æ–‡ä»¶
      - name: Find and prepare .ipk file
        id: find_ipk
        working-directory: ${{ env.SDK_DIR }}
        run: |
          translation_pkg=${PACKAGE_NAME#luci-app-}
          rm -rf upload
          mkdir -p upload
          find ./bin/packages -type f \( -name "${PACKAGE_NAME}*.ipk" -o -name "luci-i18n-${translation_pkg}-*.ipk" \) | while read -r ipk; do
            rel_path=${ipk#./}
            echo "Found IPK: $rel_path"
            cp "$ipk" upload/
          done
          if ! find upload -maxdepth 1 -type f -name '*.ipk' | grep -q '.'; then
            echo "::error::No IPK files found in ./bin/packages/"
            echo "Directory tree of ./bin/:"
            ls -R ./bin/
            exit 1
          fi
          echo "path=upload" >> $GITHUB_OUTPUT

      # æ­¥éª¤ 8: ä¸Šä¼  .ipk æ–‡ä»¶ä½œä¸ºæ„å»ºäº§ç‰©
      - name: Upload .ipk artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PACKAGE_NAME }}-${{ matrix.target.name }}
          path: ${{ env.SDK_DIR }}/${{ steps.find_ipk.outputs.path }}
          if-no-files-found: error

  release:
    name: Publish Release
    runs-on: ubuntu-latest
    needs: build
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-assets

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          generate_release_notes: true
          files: release-assets/**/*.ipk
